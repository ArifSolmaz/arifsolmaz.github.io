name: Update ORCID Publications

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

jobs:
  update-orcid:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Download works from ORCID
        run: |
          curl -L \
            -H "Accept: application/json" \
            "https://pub.orcid.org/v3.0/0000-0002-3076-164X/works" \
            -o orcid_works.json

      - name: Build publications markdown files
        run: |
          mkdir -p _includes

          # Full EN publication list
          jq -r '
            .group[]
            | .["work-summary"][0] as $w
            | ($w["publication-date"].year.value // "n.d.") as $year
            | ($w.title.title.value // "No title") as $title
            | ($w["journal-title"].value // "") as $journal
            | ($w["external-ids"]["external-id"] // []
                | map(select(.["external-id-type"]=="doi") | .["external-id-value"])
                | .[0] // "") as $doi
            | "- " + $year + " â€“ " + $title
              + (if $journal != "" then " *" + $journal + "*" else "" end)
              + (if $doi != "" then " DOI:" + $doi else "" end)
          ' orcid_works.json \
          | sort -r > _includes/publications_en_orcid.md

          # Top 3 EN
          head -n 3 _includes/publications_en_orcid.md > _includes/publications_en_orcid_top3.md

          # TR copies (same content for now)
          cp _includes/publications_en_orcid.md _includes/publications_tr_orcid.md
          cp _includes/publications_en_orcid_top3.md _includes/publications_tr_orcid_top3.md

      - name: Commit updated publications files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update publications from ORCID"
          file_pattern: |
            _includes/publications_en_orcid.md
            _includes/publications_en_orcid_top3.md
            _includes/publications_tr_orcid.md
            _includes/publications_tr_orcid_top3.md
